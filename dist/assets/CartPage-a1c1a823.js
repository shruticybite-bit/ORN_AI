import{i as Y,r as p,j as l,F as G,a as o,k as K,y as Q,b as h}from"./index-ddd0bdee.js";import{N as V,F as X}from"./Footer-809c793e.js";import"./createLucideIcon-1a266af8.js";const f="#",re=()=>{var L,F,U,j,O;const q=Y(),[i,w]=p.useState([]),[$,S]=p.useState(!1),[N,u]=p.useState(!1),[x,P]=p.useState(!1),[_,v]=p.useState(!1),m=p.useRef(null),R=t=>{if(typeof document>"u")return"";const s=`; ${document.cookie}`.split(`; ${t}=`);return s.length===2?s.pop().split(";").shift():""},d=(L=R("access")||localStorage.getItem("access")||localStorage.getItem("jwt-auth"))==null?void 0:L.trim(),b=R("user_id"),n=(t,a="info",s={})=>Q[a](t,{position:"top-center",autoClose:2e3,closeButton:!0,closeOnClick:!0,pauseOnHover:!0,draggable:!0,...s}),C=()=>!d||!b?(n("Please login to continue","error"),q("/login"),!1):!0;p.useEffect(()=>{try{const t=JSON.parse(localStorage.getItem("orl_cart")||"[]");w(t)}catch{w([])}},[]),p.useEffect(()=>()=>{m.current&&clearInterval(m.current)},[]);const E=i.reduce((t,a)=>t+Number(a.price||0),0),W=t=>{u(!0);const a=[...i];a.splice(t,1),w(a),localStorage.setItem("orl_cart",JSON.stringify(a)),n("Item removed","info"),u(!1)},B=async()=>{var t;try{return u(!0),((t=(await h.get(`${f}/users/wallet/balance/`,{headers:{Authorization:`Bearer ${d}`}})).data)==null?void 0:t.balance)??0}catch{return 0}finally{u(!1)}},A=async(t,a)=>{var s;u(!0);try{return(await h.post(`${f}/users/subscriptions/create/${t}/`,{},{headers:{Authorization:`Bearer ${d}`}})).data}catch(e){const r=(s=e==null?void 0:e.response)==null?void 0:s.data;if((r==null?void 0:r.error)==="Insufficient wallet balance"){const c=r.balance||0,g=(r.required||a)-c;n(`Wallet insufficient. Paying ₹${g} via Razorpay`,"warning"),await I(g)}else n((r==null?void 0:r.error)||"Subscription creation failed","error");return null}finally{u(!1)}},D=t=>t.split(" ")[0].toLowerCase(),k=async(t,a)=>{var s,e;u(!0),v(!0);try{if(!t.subscription){const g=await A(t.planId);if(g)t.subscription=g,n(`Subscription for ${t.name} created automatically!`,"success");else{n(`Failed to create subscription for ${t.name}`,"error");return}}const r=D(t.name),c=a==="free"?`${f}/users/deploy-free/${r}/`:`${f}/users/deploy/${r}/`,y=a==="free"?{user_id:b,action:r}:{user_id:b,action:r,payment_id:a};await h.post(c,y,{headers:{Authorization:`Bearer ${d}`}}),n(`Instance ${t.name} launched successfully!`,"success")}catch(r){n(((e=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:e.message)||"Instance launch failed","error")}finally{u(!1)}},z=(t=null)=>{m.current&&clearInterval(m.current),m.current=setInterval(async()=>{try{const e=((await h.get(`${f}/lab/userinst/${b}/`,{headers:{Authorization:`Bearer ${d}`}})).data||[]).find(r=>r.status!=="Launched"?!1:t?t==="free"?r.is_free||!r.payment_id||r.payment_id==="free":r.payment_id===t:!0);if(e){clearInterval(m.current),m.current=null,w([]),localStorage.removeItem("orl_cart");const r=(e==null?void 0:e.web_ssh_url)||(e==null?void 0:e.webssh_url)||(e==null?void 0:e.web_ssh)||(e==null?void 0:e.web_ssh_link)||(e==null?void 0:e.webssh)||(e==null?void 0:e.console_url)||(e==null?void 0:e.public_url)||(e==null?void 0:e.ssh_url)||(e==null?void 0:e.instance_url)||(e==null?void 0:e.connect_url)||(e==null?void 0:e.user_instance_link);r&&window.open(r,"_blank"),window.location.href=`/lab?user=${b}`}}catch(a){console.error("Polling error:",a)}},1e3)},J=()=>new Promise(t=>{if(window.Razorpay)return t(!0);const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.onload=()=>t(!0),a.onerror=()=>t(!1),document.body.appendChild(a)}),I=async t=>{u(!0),v(!0);try{if(!await J())return n("Failed to load Razorpay","error");const e=(await h.post(`${f}/users/create-order/`,{amount:t},{headers:{Authorization:`Bearer ${d}`}})).data,r={key:e.key_id,amount:e.amount*100,currency:"INR",name:"OnRequestLab",description:"Lab Instance Payment",order_id:e.order_id,handler:async function(c){try{if(!(await h.post(`${f}/users/verify-payment/`,{razorpay_payment_id:c.razorpay_payment_id,razorpay_order_id:c.razorpay_order_id,razorpay_signature:c.razorpay_signature},{headers:{Authorization:`Bearer ${d}`}})).data.success)return n("Payment verification failed","error");n("Payment Successful! Launching Instances...","success"),await Promise.all(i.map(g=>k(g,c.razorpay_payment_id))),z()}catch{n("Payment verification failed","error")}},modal:{ondismiss:()=>n("Payment cancelled","info")}};new window.Razorpay(r).open()}catch{n("Payment Failed!","error")}finally{u(!1)}},M=async()=>{var t,a;if(C()&&!($||N||x||_)){if(!i.length)return n("Cart empty","info");S(!0),v(!0);try{for(const s of i){if(!s.subscription){const c=await A(s.planId);s.subscription=c,n(`Subscription created for ${s.name}`,"success")}const e=await B(),r=Math.max(0,s.price-e);r===0?(n(`₹${s.price} deducted from Wallet. Launching ${s.name}...`,"success"),await k(s,"wallet")):(n(`Wallet ₹${e} insufficient. Paying ₹${r} via Razorpay`,"warning"),await I(r))}z()}catch(s){n(((a=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:a.message)||"Checkout failed","error")}finally{S(!1)}}},T=async t=>{try{return(await h.post(`${f}/users/update_active/${b}/`,{},{headers:{Authorization:`Bearer ${d}`}})).data}catch{return n("Failed to update active status","error"),null}},H=async t=>{var s,e;if(!(!C()||x||_||!window.confirm("Do you want to upgrade this plan?"))){P(!0),v(!0);try{if(!await T(t)){n("Update active failed","error");return}n("Plan activated successfully!","success");const c=await B(),y=Math.max(0,t.price-c);y===0?(n(`₹${t.price} deducted. Upgrading...`,"success"),await k(t,"wallet"),z()):(n(`Wallet low, paying ₹${y} via Razorpay`,"warning"),await I(y))}catch(r){n(((e=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:e.message)||"Upgrade failed","error")}finally{P(!1)}}};return l(G,{children:[o(V,{}),o(K,{}),($||N||x||_)&&l("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex flex-col items-center justify-center z-[9999]",children:[o("div",{className:"w-16 h-16 border-4 border-t-transparent border-purple-400 rounded-full animate-spin"}),o("p",{className:"text-white mt-4 text-xl font-semibold",children:"Please wait..."})]}),l("div",{className:"min-h-screen bg-[#070B19] text-white px-4 py-10",children:[o("h1",{className:"text-4xl font-bold mb-10",children:"Booking Details"}),l("div",{className:"flex flex-col lg:flex-row gap-10",children:[l("div",{className:"w-full lg:w-2/3 space-y-6",children:[i.map((t,a)=>l("div",{className:"border p-5 rounded-xl flex items-center justify-between shadow-sm",children:[l("div",{className:"flex items-center space-x-5",children:[o("div",{className:"w-32 h-20 bg-gray-200 rounded-lg"}),l("div",{children:[o("h2",{className:"text-xl font-semibold",children:t.name}),o("p",{className:"text-sm text-gray-400 mt-1",children:t.newdescription}),l("p",{className:"text-sm text-gray-400 mt-1",children:["Billing: ",o("span",{className:"font-bold",children:t.billingType})]}),o("div",{className:"mt-3"}),o("button",{onClick:()=>W(a),disabled:N||$||x||_,className:"text-purple-600 font-semibold mt-2 hover:underline disabled:opacity-50",children:"Remove"})]})]}),l("div",{className:"text-2xl font-bold",children:["₹",t.price]})]},a)),!i.length&&o("p",{className:"text-gray-500 text-xl",children:"Your cart is empty."})]}),l("div",{className:"w-full lg:w-1/3 border p-6 rounded-2xl shadow-md h-fit",children:[o("h3",{className:"text-xl font-bold mb-5",children:"Total:"}),l("p",{className:"text-4xl font-bold mb-5",children:["₹",E]}),o("button",{onClick:()=>H(i[0]),disabled:!((F=i[0])!=null&&F.subscription),className:`w-full mb-4 px-4 py-3 rounded-xl font-bold text-white ${(U=i[0])!=null&&U.subscription?"bg-gradient-to-r from-purple-600 to-blue-500 hover:scale-105":"bg-gray-700 opacity-60 cursor-not-allowed"}`,children:"Upgrade"}),o("button",{onClick:M,disabled:(j=i[0])==null?void 0:j.subscription,className:`w-full px-4 py-3 rounded-xl font-bold text-white ${(O=i[0])!=null&&O.subscription?"bg-gray-700 opacity-60 cursor-not-allowed":"bg-gradient-to-r from-pink-500 to-purple-600 hover:scale-105"}`,children:"Checkout"})]})]})]}),o(X,{})]})};export{re as default};
